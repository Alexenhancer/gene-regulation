---
title: "Running the gene-regulation pipelines with Docker"
author: "Claire Rioualen"
date: "April 25, 2016"
output:
  html_document:
    fig_caption: yes
    highlight: zenburn
    number_sections: yes
    theme: cerulean
    toc: yes
    toc_depth: 5
  pdf_document:
    fig_caption: yes
    highlight: zenburn
    number_sections: yes
    toc: yes
    toc_depth: 5
---

> Note: this is a first draft. 

# Get started with Docker!

## Create a Docker account

Instructions[here](https://docs.docker.com/linux/step_five/).

## Install Docker on your local host

Instructions for a linux install can be found [here](https://docs.docker.com/linux/), along with mac and windows instructions. 

You can test whether it works properly:

```
docker run hello-world
```

<!--
Run the following command:
```
sudo apt-get --yes install docker
```
--> 

## Create shared repositories and download source data

You can enter the following commands directly, or chose your own location. 

```
sudo mkdir -p /data/source/GSE20870/GSM521934 /data/source/GSE20870/GSM521935
sudo mkdir -p /data/results/GSE20870
```
```
cd /data/source/GSE20870/GSM521934
wget ftp://ftp-trace.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByExp/sra/SRX%2FSRX021%2FSRX021358/SRR051929/SRR051929.sra
cd /data/source/GSE20870/GSM521935
wget ftp://ftp-trace.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByExp/sra/SRX%2FSRX021%2FSRX021359/SRR051930/SRR051930.sra
```



## Fetch the Docker image and run it with shared folders

```
docker pull rioualen/gene-regulation:1.0
docker run -v /data/results/GSE20870/:/data/results/GSE20870/ -v /data/GSE20870/:/data/GSE20870/ -it rioualen/gene-regulation:1.0 /bin/bash
```

You can share as many folders as desired, using this syntax: `-v /path/on/host/:/path/on/docker/`.


## Execute the pipeline

```
snakemake -s scripts/snakefiles/workflows/factor_workflow.py -p
```

<!--
# JVH / Mac

## Quick tour

On Mac OSX

### 1. Install docker

        https://docs.docker.com/engine/installation/mac/

### 2. Open the application Docker Quickstart Terminal. This open a new terminal window and launches the docker daemon.

### 3. Get the gene-regulation docker

docker pull rioualen/gene-regulation:0.3

### 4. Check the list of docker images available locally

docker images

### 5. Start the gene-regulation image. The option `-it` specifies the interactive mode, which is necessary to be able using this VM

```
docker run -it rioualen/gene-regulation:0.3 /bin/bash
```

You are now in a bash session of a gene-regulation docker. In this session, you are "root" user, i;e. you have all the administration rights. You can check this easily:

```
whoami
```



### 6. Check the disks available on this docker

```
df -h
```

Currently, your docker can only access its local disk, which comes with the VM.
**Beware**: any data stored on this local disk will be lost when you shut down the gene-regulation docker.

### 7. Exit and get back to your gene-regulation container

 If you exits your shell session, the docker will still be running.


```
exit
```

You are now back to the host terminal.

Check the currently active docker containers (processes).

```
docker ps -a
```

Note that you can run several containers of the same image.
Each active container has a unique identifier which appears in the first column when you run `docker ps` (e.g. `faff5298ef95`).
You can re-open a running container with the command

```
docker attach [CONTAINER_ID]
```
where `[CONTAINER_IDR]` must be replaced by the actual ID of the running docker container (e.g. `faff5298ef95`).


### 8. Shutting down the container

We will now shut down this image, and start a new one which will enable you to store persistent data.

```
docker stop [CONTAINER_ID]
```

### 9. Starting a docker container with a shared folder.



  500  docker pull rioualen/gene-regulation:0.3
  501  mkdir -p ~/gene-regulation_data/GSE20870/GSM521934 ~/gene-regulation_data/GSE20870/GSM521935
  502  cd ~/gene-regulation_data/GSE20870/GSM521934
  503  wget ftp://ftp-trace.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByExp/sra/SRX%2FSRX021%2FSRX021358/SRR051929/SRR051929.sra
  504  cd ~/gene-regulation_data/GSE20870/GSM521935
  505  wget ftp://ftp-trace.ncbi.nlm.nih.gov/sra/sra-instant/reads/ByExp/sra/SRX%2FSRX021%2FSRX021359/SRR051930/SRR051930.sra
  506  mkdir ~/gene-regulation_data/results/GSE20870
  507  mkdir -p ~/gene-regulation_data/results/GSE20870
  508  docker pull rioualen/gene-regulation:0.3
  509  docker run -v ~/gene-regulation_data:/data  -it rioualen/gene-regulation:0.3 /bin/bash

### 10. Running the snakemake demo workflow on the docker container

    1  ls /data
    2  ls /data/GSE20870/
    3  ls /data/GSE20870/GSM521934/
    4  exit
    5  ls /data
    6  source ~/bin/ngs_bashrc
    7  snakemake -s scripts/snakefiles/workflows/factor_workflow.py -np
    8  history
    9  snakemake -s scripts/snakefiles/workflows/factor_workflow.py -np
   10  snakemake -s scripts/snakefiles/workflows/factor_workflow.py -p







## Questions

1. Quand on fait un login dans la vm gene--regulation, on entre dans un shell basique (pas bash). Est-il possible de configurer docker pour qu'on entre automatiquement en bash ?

Entry point /bin/bash


2. Il faut ajouter le bashrc dans le /etc du docker.

-->