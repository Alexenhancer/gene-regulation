"""featureCounts from the subread toolkit. 

Required parameters:
    config["qsub"]
    config["dir"]["base"]

Usage: 
    Usage: featureCounts [options] -a <annotation_file> -o <output_file> input_file1 [input_file2] ... 

Authors: 
    Claire Rioualen
"""

# Set parameters
if not "qsub" in config.keys():
    sys.exit("The parameter qsub must be defined in the config file")

config["subread-align"]["feature_type"] = "transcript"     ## TODO properly

# Define paths
genome_gtf = config["dir"]["genome"] + config["genome"]["version"] + "/" + config["genome"]["version"] + ".gtf"

# Define input files (no global variables allowed?)
def featureCounts_inputs(wildcards):
    SAMPLE_IDS = read_table(config["metadata"]["samples"]).iloc[:,0]
    bam_files =  expand(SAMPLE_DIR + "{samples}/{samples}_{aligner}.bam", samples=SAMPLE_IDS, aligner=wildcards.aligner)
    return bam_files

rule subread_featureCounts:
    input: 
        bam = "{reads}_sorted_pos.bam",
        gtf = genome_gtf
    output: "{reads}_featureCounts_transcripts.txt"
    params:
        wd = config["dir"]["base"],
        feature_type = config["subread-align"]["feature_type"], 
        qsub = config["qsub"]\
            + " -e {reads}_featureCounts_qsub.err"\
            + " -o {reads}_featureCounts_qsub.out"
    log: "{reads}_featureCounts.log"
    benchmark: "{reads}_featureCounts_benchmark.json"
    run:
        shell("featureCounts -a {input.gtf} -o {output} {input.bam} -t {params.feature_type} &> {log}")
        R("""
            setwd("{params.wd}")
            counts <- read.table("{output}", header=TRUE)
            new <- counts[,-which(names(counts) %in% c("Chr", "Start", "End", "Strand", "Length"))]
            write.table(new, file = "{output}", sep="\t", col.names=FALSE, row.names=FALSE)
        """)






