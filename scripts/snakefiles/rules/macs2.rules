rule macs2:
	"""Peak-calling with MACS2.
	Input: sam, bam, bed... automatically detected by macs' callpeak algorithm. Bed format was used here. 
	Output: bed

	To be refined...
	TODO:
		Add qsub, log, bench, message keywords.
		Generalize rule... And clean up this mess of a file once it's done.

	Required parameters:
		config['qsub']
		config['macs2']['genome']
		config['dir']['results']

	Usage: 
		MACS2 = expand(config["dir"]["results"] + "{chip}_vs_{inp}/{chip}_vs_{inp}_{trimming}_{aligner}_{caller}_peaks.xls", chip=CHIP, inp=INPUT, trimming=TRIMMING, aligner=ALIGNER, caller=PEAK_CALLER)
	"""
        input: treatment="{result_dir}/{treatment}/{treatment}" + config["suffixes"]["mapped"] + ".bed", \
            control="{result_dir}/{control}/{control}" + config["suffixes"]["mapped"] + ".bed"
	output: narrowpeaks = "{result_dir}/{treatment}_vs_{control}/macs2/{treatment}_vs_{control}" + config["suffixes"]["mapped"] + "_macs2_peaks.narrowPeak", \
                peaks_bed = "{result_dir}/{treatment}_vs_{control}/macs2/{treatment}_vs_{control}" + config["suffixes"]["mapped"] + "_macs2_peaks.bed", \
                peak_len = "{result_dir}/{treatment}_vs_{control}/macs2/{treatment}_vs_{control}" + config["suffixes"]["mapped"] + "_macs2_peaklen.tab", \
                summits = "{result_dir}/{treatment}_vs_{control}/macs2/{treatment}_vs_{control}" + config["suffixes"]["mapped"] + "_macs2_summits.bed"
        log: "{result_dir}/{treatment}_vs_{control}/macs2/{treatment}_vs_{control}" + config["suffixes"]["mapped"] + "_macs2.log"
        benchmark: "{result_dir}/{treatment}_vs_{control}/macs2/{treatment}_vs_{control}" + config["suffixes"]["mapped"] + "_macs2_benchmark.json"
        params: outdir="{result_dir}/{treatment}_vs_{control}", \
            name="{treatment}_vs_{control}" + config["suffixes"]["mapped"] + "_macs2", \
            qval = config["macs2"]["qval"], \
            call_summits = config["macs2"]["call_summits"], \
            keep_dup = config["macs2"]["keep_dup"], \
            band_width = config["macs2"]["band_width"], \
            mfold_min = config["macs2"]["mfold_min"], \
            mfold_max = config["macs2"]["mfold_max"], \
            other_options = config["macs2"]["other_options"], \
            genome_size = config["genome"]["size"], \
            qsub=config["qsub"] \
                  + " -q long -e {result_dir}/{treatment}_vs_{control}/macs2/{treatment}_vs_{control}" + config["suffixes"]["mapped"] + "_macs2_qsub.err" \
                  + " -q long -e {result_dir}/{treatment}_vs_{control}/macs2/{treatment}_vs_{control}" + config["suffixes"]["mapped"] + "_macs2_qsub.out" 
	shell: "(macs2 \
callpeak -t {input.treatment} -c {input.control} --gsize {params.genome_size} \
--qvalue {params.qval} \
--keep-dup {params.keep_dup} \
--bw {params.band_width} \
--mfold {params.mfold_min} {params.mfold_max} \
--outdir {params.outdir} --name {params.name} \
{params.call_summits} {params.other_options} ; \
convert-features -from bed3col -to bed3col -i {output.narrowpeaks} -o {output.peaks_bed}; \
sequence-lengths -i {output.peaks_bed} -in_format bed | classfreq -ci 10 -v 1 -o {output.peak_len}) &> {log}"

