"""
	Align each sample with the R-package subread

	For aligned each sample on the genome reference the R-package subread need to build a index by the function 
	builindex(), and then we execute the alignement with the function align() who call the tool Subread.
	Liao Y, Smyth GK and Shi W (2013). The Subread aligner: fast, accurate and scalable read mapping by seed-and-vote.
	Nucleic Acids Research, 41(10):e108
"""
rule buildindex_mapping:
	"""This rule build the index necessary to process the alignement"""
	input: reference_genome = config["subread"]["reference_genome"]
	output: config["dir"]["results"] + "control_buildindex.txt"
	params: reference_index = config["dir"]["results"] + config["subread"]["basename"], qsub = config["qsub"] + " -q short -e " + config["dir"]["results"] + "buildindex_qsub.err -o " + config["dir"]["results"] + "buildindex_qsub.out"
	log: config["dir"]["results"] + "buildindex.log"
	benchmark: config["dir"]["results"] + "buildindex_benchmark.json"
	run: 
		R("""
			library("Rsubread")
			buildindex(basename="{params.reference_index}",reference="{input.reference_genome}")
			write("buildindex ok", file="{output}")
		""")
			
rule subread_mapping:
	"""This rule execute the alignement with the subread tool"""
	input: file_input = "{data_dir}/{dataset}_{trimmed}.fastq", control_txt = config["dir"]["results"] + "control_buildindex.txt"
	output: "{data_dir}/{dataset}_{trimmed}_{aligneur}.bam"
	params: reference_index = config["dir"]["results"] + config["subread"]["basename"], qsub = config["qsub"] + " -q medium -e {data_dir}/{dataset}_{trimmed}_{aligneur}_subread_mapping_qsub.err -o {data_dir}/{dataset}_{trimmed}_{aligneur}_subread_mapping_qsub.out"
	log: "{data_dir}/{dataset}_{trimmed}_{aligneur}_subread_mapping.log"
	benchmark: "{data_dir}/{dataset}_{trimmed}_{aligneur}_subread_mapping_benchmark.json"
	run: 
		R(""" 
			library("Rsubread")
			align(index="{params.reference_index}",readfile1="{input.file_input}",output_file="{output}")
		""")